---
title: "Accounting for imperfect detection in functional ecology using hierarchical models in R"
author: "Tobias Roth"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Accounting for imperfect detection in functional ecology using hierarchical models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction
Currently, most studies in functional ecology calculate measures of functional diversity directly from  observations, which are usually the counts or observed presences of several species at a number of sites (a site x species matrix which we call the observed meta-community). However, if measurement errors occur and especially if the measurement errors depend on species' traits, functional diversity measures are likely to be affected (Cardoso et al. 2014; Mihaljevic, Joseph & Johnson 2015; van der Plas et al. 2017). 

In their excellent book Kéry & Royle (2016) advocated hierarchical models as an unifying concept in ecology to infer biological processes independent of measurement errors. They also introduce the package [`unmarked`](https://sites.google.com/site/unmarkedinfo/home) that makes it easy to apply these methods in real-world applications. In this vignette we provide a working example how these methods could be applied in studies of functional diversity. 

As a requirement to run the presented code the latest version of the `detecionfilter` package should be downloaded using the following code. 

```{r, echo=TRUE, message=FALSE, warning=FALSE, cache=TRUE}
library(devtools)
install_github("TobiasRoth/detectionfilter")
library(detectionfilter)
```

The `detectionfilter` package provides the function `simcom()` to simulate meta-community data where the change of species' occurrence along a gradient depends on its trait expression (i.e. environmental filtering) and where species' detection during field surveys also depends on trait expression (i.e detection filtering). It is convenient to use simulated data in a working example as it allows to compare the estimates with the truth (i.e. the values used for the parameters to run the simulations). See the vignette *Simulation of meta-community data subject to environmental and detection filtering* that describes the simulation parameters and the concept of the simulation in more detail. 

We start with simulating data for a study with 200 sites, each site was visited twice and the regional species pool contains 100 species. 

```{r, cache=TRUE}
set.seed(1234)
dat <- simcom(mu.FTfilter.lp = 1, mean.psi = 0.8, 
              mu.FTfilter.lpsi = -0.5, mean.p = 0.8,
              nsite = 200, nspec = 100, nrep = 2)
```

In this simulation we assumed that an average species occurred in 80% of the sites (`mean.psi = 0.8`) and during one survey in average species were observed in 80% of the sites they actually occurred (`mean.p = 0.8`). These are rather high values for average species' occurrence and detection. Consequently, all species were observed  and except for one species that was observed only at four sites all other species were observed at more than 20 sites. 

```{r, cache=TRUE}
# Calculate observed meta-community (i.e. merge the observations from the two visits)
commat_obs <- apply(dat$y, c(1,2), max)

# Show species with few observations
sort(apply(commat_obs, 2, sum))[1:10]
```

Thus, in this example we do not face the problem that we have to exclude many species because they have too few observations. Excluding many rarely observed species (either because they are indeed rare or because they are hard to detect) could bias the results on functional diversity because these species might be special in terms of their functional traits. In the last chapter of this vignette we therefore tested our approach under a simulation with many species that were not observed at all or observed at only few sites. 


# Estimating detection corrected communites
Estimators of functional diversity may be constructed from model-based estimators of occurrence of individual species that incorporate imperfect detection of species (Dorazio and Royle 2005). In the hierarchical models as defined by Kéry and Royle (2016) the model-based estimator of species' occurence (or abundance) is denoted as the vector 'z' with length equal to the number of surveyed sites. Thus, `z` describes the true occurence of a species and can be related to site variables using logistic regression. However, whether a species is observed at site `i` during visit `j`  (`y[i,j]`) depends on variables affecting detection as well as on its occurence (that is `z[i]`). Indeed, the hierarchical structure that the observations conditionally depend on the outcome of the biological process (`f(y|z)`) is the overarching principle in many differnt ecological model suche as capture-recapture models, distance sampling models, occupancy models or N-mixture models for abundance (Kéry and Royle 2016).

In short we need to pick one of the many hierarchical models that best fits the structure of our data. Applying this model to all species seperately would reveal the true occurence (or abundance) for all species and sites. Taking the true occurences of all species (the 'z' for all species) results in the site x species matrix that we call the detection-corrected meta-community matrix. From this detection-corrected meta-community matrix we can then calculate  functional diversity. We here use the term functional diversity to refer to one of the many indices of functional diversity that use the presence/absence or abundance of species at different sites (site x species matrix) and the measure of functional traits of the species to calculate some indices that should describe communities in terms of their functional space. Such measures could range from the simple average of the trait expression of species in the community to multi-trait measures of the functional diversity (Mason et al. 2005). Functional diversity calculated from detection-corrected meta-community matrix should be independent from detection filtering (Dorazio and Royle 2005). A comparison between functional diversity calculated from the observations and functional diversity calculated from the detection-corrected meta-community matrix would reveal how detection filtering affects functional diversity.

Since most of the methods to account for measurement errors in hierarchical models are implemented in the R-package `unmarked`, to calculate the detection corrected community matrix `z` only needs few lines of R-code. The function `unmarkedFrameOccu()` organizes detection, non-detection data along with the covariates. The function `occu()` fits the single season occupancy model of MacKenzie et al. (2002). A single season occupancy model is a hierarchical model in the form of `f(y|z)` were y are observed species presence and z is the true species presence. The function `ranef()` estimates posterior distributions of the `z`using empirical Bayes methods. This function can be applied to all hierarchical models implemented in the package `unmarked`. Finally, we use  the function `bup()` to extract the mode of the osterior probability. All these functions are from the package `unmarked`.

```{r, message=FALSE, warning=FALSE, cache=TRUE}
# Package to fit hierarchical models of occurrence and abundance data
library(unmarked)

# Prepare detection corrected community matrix
z <- array(NA, dim = c(dim(dat$y)[1], dim(dat$y)[2]))

# Apply hierarchical model to all species seperate
for(k in 1:dim(dat$y)[2]) {
  d <- unmarkedFrameOccu(y = dat$y[,k,], obsCovs = list(date = dat$date),
                         siteCovs = data.frame(gradient = dat$gradient))
  res <- occu(~ date ~ gradient, data = d, se = TRUE)
  z[,k] <- bup(ranef(res), stat = "mode")
}
```

Let's assume we are interested in how the mean trait expression of the species in a community (i.e. community mean CM) changes along the gradient. We calculate CMs from observed meta-community, from the detection-corrected community matrix and from the true community matrix that we only know because we simulated the data. 


```{r, cache=TRUE, fig.height=4}
# Function to calculate mean trait expression of species in a community
CM <- function(x) mean(dat$traitmat[x])

# Calculate community mean value of trait expression (CM)
CM_obs <- apply(commat_obs==1, 1, CM)
CM_cor <- apply(z>0.5, 1, CM)
CM_true <- apply(dat$z_true==1, 1, CM)

# Plot CM along gradient
plot(dat$gradient, CM_obs, pch = 16, cex = 0.7, ylim = c(-1, 1), 
     xlab = "Gradient", ylab = "Community mean")
points(dat$gradient, CM_true, cex = 0.7, col = "orange")
points(dat$gradient, CM_cor, pch = "+", cex = 0.7, col = "red")
abline(lm(CM_obs ~ dat$gradient))
abline(lm(CM_true ~ dat$gradient), col = "orange")
abline(lm(CM_cor ~ dat$gradient), col = "red")
```

**Fig. 1:** Mean trait expression (CM) of true communities (open orange dots, only known because data are simulated), CMs of observed communities (black dots) and CMs from detection-corrected communities (red +) along elevational gradient.

Community mean calculated from observed meta-communities is biased high because species with low trait values are more likely to remain undetected than species with larger trait values. Clearly, functional diversity calculated from detection corrected communities is  closer to the truth.  

# References
Cardoso, P.; Rigal, F.; Borges, P. A. V.; Carvalho, J. C.; Faith, D., 2014. A new frontier in biodiversity inventory: a proposal for estimators of phylogenetic and functional diversity. - Methods in Ecology and Evolution 5: 452-461.

Dorazio, R. M.; Royle, J. A., 2005. Estimating size and composition of biological communities by modeling the occurrence of species. - Journal of the American Statistical Association 100: 389-398.

Kéry, M.; Royle, J. A., 2016. Applied Hierarchical Modeling in Ecology. Academic Press.

Mason, N. W. H.; Mouillot, D.; Lee, W. G.; Wilson, J. B., 2005. Functional richness, functional evenness and functional divergence: the primary components of functional diversity. - Oikos 111: 112-118.

Mihaljevic, J. R.; Joseph, M. B.; Johnson, P. T. J., 2015. Using multispecies occupancy models to improve the characterization and understanding of metacommunity structure. - Ecology 96: 1783-1792.

van der Plas, F.; van Klink, R.; Manning, P.; Olff, H.; Fischer, M., 2017. Sensitivity of functional diversity metrics to sampling intensity. - Methods in Ecology and Evolution.
